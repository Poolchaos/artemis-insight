pipeline {
    agent any

    environment {
        GHCR_URL = 'ghcr.io/poolchaos'
        IMAGE_NAME = 'artemis-insight-backend'
        PROD_SERVER = credentials('PROD_SERVER_SSH')
        DOCKER_BUILDKIT = '1'
    }

    options {
        skipDefaultCheckout(true)
        disableConcurrentBuilds()
        lock(resource: 'artemis-insight-deployment', skipIfLocked: false)  // Global lock across all pipelines
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {
        stage('Initial Memory Check & Build Lock') {
            steps {
                script {
                    echo "≡ƒÜª === INITIAL MEMORY ASSESSMENT ==="

                    sh '''
                        echo "≡ƒôè Initial memory status:"
                        free -h

                        # Get available memory
                        AVAILABLE_MB=$(free -m | awk 'NR==2{printf "%d", $7}')
                        echo "≡ƒÆ╛ Available memory: ${AVAILABLE_MB}MB"

                        # Basic Docker cleanup
                        echo "≡ƒº╣ Basic Docker cleanup..."
                        docker container prune -f 2>/dev/null || echo "Container cleanup completed"
                        docker image prune -f 2>/dev/null || echo "Image cleanup completed"

                        # Simple build lock
                        echo "≡ƒöÆ Creating build lock..."
                        mkdir -p /tmp/jenkins-artemis-insight-api-build
                        echo "$(date +%s):$$:artemis-insight-api" > /tmp/jenkins-artemis-insight-api-build/lock

                        # Memory assessment
                        AVAILABLE_MB=$(free -m | awk 'NR==2{printf "%d", $7}')
                        if [ "$AVAILABLE_MB" -lt "200" ]; then
                            echo "≡ƒÜ¿ CRITICAL MEMORY: ${AVAILABLE_MB}MB - build may fail"
                            echo "≡ƒÆí Proceeding but expect potential failures"
                        elif [ "$AVAILABLE_MB" -lt "400" ]; then
                            echo "ΓÜá∩╕Å LOW MEMORY: ${AVAILABLE_MB}MB - using minimal strategy"
                        else
                            echo "Γ£à SUFFICIENT MEMORY: ${AVAILABLE_MB}MB"
                        fi

                        echo "Γ£à Ready for workspace setup"
                    '''
                }
            }
        }

        stage('Workspace Setup') {
            steps {
                echo "≡ƒº╣ === WORKSPACE SETUP ==="
                script {
                    // Smart cleanup - preserve caches
                    sh '''
                        if [ -d ".git" ]; then
                            echo "≡ƒöä Selective cleanup preserving caches..."
                            git clean -ffdx -e "**/__pycache__" -e "**/.pytest_cache"
                        else
                            echo "≡ƒåò Fresh workspace detected"
                        fi
                    '''

                    // Explicit checkout
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [
                            [$class: 'CleanBeforeCheckout'],
                            [$class: 'CloneOption', depth: 1, shallow: true]
                        ],
                        userRemoteConfigs: [[
                            url: 'https://github.com/Poolchaos/artemis-insight.git',
                            credentialsId: 'github-repo-access'
                        ]]
                    ])

                    // Set environment variables
                    env.IMAGE_TAG = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.FULL_IMAGE_NAME = "${GHCR_URL}/${IMAGE_NAME}:${env.IMAGE_TAG}"

                    // Automated verification
                    sh '''
                        echo "Γ£à Checkout completed"
                        echo "≡ƒôï Image: ${FULL_IMAGE_NAME}"

                        # Verify workspace structure
                        echo "≡ƒöì Verifying workspace structure..."

                        # Check critical files exist
                        if [ ! -d "backend" ]; then
                            echo "Γ¥î ERROR: backend directory not found!"
                            pwd && ls -la
                            exit 1
                        fi

                        if [ ! -f "backend/Dockerfile" ]; then
                            echo "Γ¥î ERROR: backend/Dockerfile not found!"
                            exit 1
                        fi

                        if [ ! -f "backend/requirements.txt" ]; then
                            echo "Γ¥î ERROR: backend/requirements.txt not found!"
                            exit 1
                        fi

                        echo "Γ£à Backend structure verified"
                        echo "Γ£à Moving to Docker build stage"
                    '''
                }
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    echo "≡ƒÉ│ === API DOCKER BUILD ==="
                    echo "Building: ${env.FULL_IMAGE_NAME}"

                    sh '''
                        set -e

                        echo "≡ƒöì Pre-build verification..."
                        echo "Build context: $(pwd)/backend"
                        echo "Dockerfile location: $(ls -la backend/Dockerfile)"

                        # Pull latest image for cache
                        echo "≡ƒôÑ Pulling latest image for build cache..."
                        docker pull ${GHCR_URL}/${IMAGE_NAME}:latest || echo "No cache image available, will build from scratch"

                        # Memory-adaptive build strategy
                        AVAILABLE_MB=$(free -m | awk 'NR==2{printf "%d", $7}')
                        echo "≡ƒÆ╛ Available memory: ${AVAILABLE_MB}MB"

                        if [ "$AVAILABLE_MB" -gt "1200" ]; then
                            echo "≡ƒÆ¬ Using optimal build settings..."
                            MEMORY_LIMIT="1024m"
                            SWAP_LIMIT="1536m"
                            CPU_QUOTA="50000"
                        elif [ "$AVAILABLE_MB" -gt "800" ]; then
                            echo "ΓÜû∩╕Å Using balanced build settings..."
                            MEMORY_LIMIT="800m"
                            SWAP_LIMIT="1200m"
                            CPU_QUOTA="30000"
                        else
                            echo "≡ƒÉî Using emergency minimal build settings..."
                            MEMORY_LIMIT="600m"
                            SWAP_LIMIT="800m"
                            CPU_QUOTA="20000"
                        fi

                        # Build API Docker image
                        echo "≡ƒôª Building Artemis Insight API Docker image..."
                        echo "Memory: $MEMORY_LIMIT, Swap: $SWAP_LIMIT, CPU: $CPU_QUOTA"

                        docker build \\
                            --progress=plain \\
                            --cache-from ${GHCR_URL}/${IMAGE_NAME}:latest \\
                            --build-arg BUILDKIT_INLINE_CACHE=1 \\
                            --memory=$MEMORY_LIMIT \\
                            --memory-swap=$SWAP_LIMIT \\
                            --cpu-quota=$CPU_QUOTA \\
                            --cpu-period=100000 \\
                            --shm-size=64m \\
                            -f backend/Dockerfile \\
                            -t ${FULL_IMAGE_NAME} \\
                            backend/

                        echo "Γ£à Artemis Insight API Docker image built successfully"
                    '''
                }
            }
        }

        stage('Push to Registry') {
            steps {
                withCredentials([
                    string(credentialsId: 'GHCR_USERNAME', variable: 'GHCR_USER'),
                    string(credentialsId: 'GHCR_TOKEN', variable: 'GHCR_PAT')
                ]) {
                    script {
                        echo "≡ƒôñ === API PUSH TO REGISTRY ==="

                        sh '''
                            set -e

                            echo "≡ƒôñ Pushing Artemis Insight API Docker image..."
                            echo "${GHCR_PAT}" | docker login ghcr.io -u "${GHCR_USER}" --password-stdin
                            docker push ${FULL_IMAGE_NAME}

                            echo "≡ƒÅ╖∩╕Å Tagging and pushing as latest for cache..."
                            docker tag ${FULL_IMAGE_NAME} ${GHCR_URL}/${IMAGE_NAME}:latest
                            docker push ${GHCR_URL}/${IMAGE_NAME}:latest

                            echo "Γ£à API image pushed successfully: ${FULL_IMAGE_NAME}"
                            echo "Γ£à Cache image updated: ${GHCR_URL}/${IMAGE_NAME}:latest"
                        '''
                    }
                }
            }
        }

        stage('Approve Deploy') {
            steps {
                script {
                    echo "≡ƒñö === DEPLOY CONFIRMATION REQUIRED ==="
                    echo "≡ƒôï Ready to deploy: ${env.FULL_IMAGE_NAME}"
                    echo "≡ƒÄ» Target: Artemis Insight API Production"
                    echo "ΓÅ░ Build will wait for deployment approval"

                    // Store current state
                    sh '''
                        echo "≡ƒô╕ Capturing current deployment state..."
                        ssh -o StrictHostKeyChecking=no ${PROD_SERVER} "
                            echo '=== Current Artemis Insight API Container Status ==='
                            docker ps --filter name=artemis-insight-backend || echo 'No API container running'
                            echo '=== Current Artemis Insight API Images ==='
                            docker images | grep artemis-insight-backend | head -5 || echo 'No API images found'
                        " > deployment-state.log || echo "Could not capture remote state"

                        cat deployment-state.log || echo "No state log available"
                    '''

                    // Use milestone to avoid blocking executor
                    milestone(ordinal: 1, label: 'Pre-Deploy Approval')

                    // Manual approval
                    timeout(time: 30, unit: 'MINUTES') {
                        input message: '≡ƒÜÇ Deploy Artemis Insight API to Production?', ok: 'Deploy Now'
                    }

                    milestone(ordinal: 2, label: 'Post-Deploy Approval')

                    echo "Γ£à Deployment approved - proceeding with deployment"
                }
            }
        }

        stage('Deploy Infrastructure') {
            steps {
                withCredentials([
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_USERNAME', variable: 'ARTEMIS_INSIGHT_MONGO_USERNAME'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_PASSWORD', variable: 'ARTEMIS_INSIGHT_MONGO_PASSWORD'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_DATABASE', variable: 'ARTEMIS_INSIGHT_MONGO_DATABASE'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_USER', variable: 'ARTEMIS_INSIGHT_MINIO_USER'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_PASSWORD', variable: 'ARTEMIS_INSIGHT_MINIO_PASSWORD')
                ]) {
                    script {
                        echo "≡ƒÅù∩╕Å === DEPLOYING INFRASTRUCTURE SERVICES ==="

                        sh '''
                            echo "≡ƒöù Connecting to production server..."
                            ssh -o StrictHostKeyChecking=no ${PROD_SERVER} "
                                set -e

                                # Ensure network exists
                                echo '≡ƒîÉ Ensuring Docker network exists...'
                                if docker network inspect artemis-insight-net >/dev/null 2>&1; then
                                    echo 'Γ£à Network already exists'
                                else
                                    docker network create artemis-insight-net --subnet 172.22.0.0/16
                                    echo 'Γ£à Network created with subnet 172.22.0.0/16'
                                fi

                                # Check if MongoDB already exists
                                if docker ps -a --filter name=artemis-insight-mongodb --format '{{.Names}}' | grep -q artemis-insight-mongodb; then
                                    echo 'Γ£à MongoDB already exists - skipping deployment'
                                else
                                    # Deploy MongoDB
                                    echo '≡ƒùä∩╕Å Deploying MongoDB...'
                                    docker run -d --name artemis-insight-mongodb \\
                                        --restart unless-stopped \\
                                        --network artemis-insight-net \\
                                        -p 127.0.0.1:27018:27017 \\
                                        -e MONGO_INITDB_ROOT_USERNAME='${ARTEMIS_INSIGHT_MONGO_USERNAME}' \\
                                        -e MONGO_INITDB_ROOT_PASSWORD='${ARTEMIS_INSIGHT_MONGO_PASSWORD}' \\
                                        -e MONGO_INITDB_DATABASE='${ARTEMIS_INSIGHT_MONGO_DATABASE}' \\
                                        -v artemis-insight-mongodb-data:/data/db \\
                                        mongo:7.0 --auth --bind_ip_all

                                    echo 'Γ£à MongoDB deployed'
                                fi

                                # Check if Redis already exists
                                if docker ps -a --filter name=artemis-insight-redis --format '{{.Names}}' | grep -q artemis-insight-redis; then
                                    echo 'Γ£à Redis already exists - skipping deployment'
                                else
                                    # Deploy Redis
                                    echo '≡ƒùä∩╕Å Deploying Redis...'
                                    docker run -d --name artemis-insight-redis \\
                                        --restart unless-stopped \\
                                        --network artemis-insight-net \\
                                        -p 127.0.0.1:6381:6379 \\
                                        -v artemis-insight-redis-data:/data \\
                                        redis:7-alpine redis-server --appendonly yes

                                    echo 'Γ£à Redis deployed'
                                fi

                                # Check if MinIO already exists
                                if docker ps -a --filter name=artemis-insight-minio --format '{{.Names}}' | grep -q artemis-insight-minio; then
                                    echo 'Γ£à MinIO already exists - skipping deployment'
                                else
                                    # Deploy MinIO
                                    echo '≡ƒôª Deploying MinIO...'
                                    docker run -d --name artemis-insight-minio \\
                                        --restart unless-stopped \\
                                        --network artemis-insight-net \\
                                        -p 127.0.0.1:9002:9000 \\
                                        -p 127.0.0.1:9003:9001 \\
                                        -e MINIO_ROOT_USER='${ARTEMIS_INSIGHT_MINIO_USER}' \\
                                        -e MINIO_ROOT_PASSWORD='${ARTEMIS_INSIGHT_MINIO_PASSWORD}' \\
                                        -v artemis-insight-minio-data:/data \\
                                        minio/minio:latest server /data --console-address ':9001'

                                    echo 'Γ£à MinIO deployed'
                                fi

                                # Wait for services to be ready
                                echo 'ΓÅ│ Waiting for services to start...'
                                sleep 10

                                # Verify Redis
                                if docker exec artemis-insight-redis redis-cli ping | grep -q PONG; then
                                    echo 'Γ£à Redis is healthy'
                                else
                                    echo 'ΓÜá∩╕Å Redis health check failed'
                                fi

                                # Verify MinIO
                                if docker ps --filter name=artemis-insight-minio --format '{{.Status}}' | grep -q 'Up'; then
                                    echo 'Γ£à MinIO is running'
                                else
                                    echo 'ΓÜá∩╕Å MinIO health check failed'
                                fi

                                echo 'Γ£à Infrastructure deployment completed'
                            "
                        '''

                        echo "Γ£à Infrastructure services deployed"
                    }
                }
            }
        }

        stage('Deploy to Production') {
            steps {
                withCredentials([
                    string(credentialsId: 'GHCR_USERNAME', variable: 'GHCR_USER'),
                    string(credentialsId: 'GHCR_TOKEN', variable: 'GHCR_PAT'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_USERNAME', variable: 'ARTEMIS_INSIGHT_MONGO_USERNAME'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_PASSWORD', variable: 'ARTEMIS_INSIGHT_MONGO_PASSWORD'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_DATABASE', variable: 'ARTEMIS_INSIGHT_MONGO_DATABASE'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_USER', variable: 'ARTEMIS_INSIGHT_MINIO_USER'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_PASSWORD', variable: 'ARTEMIS_INSIGHT_MINIO_PASSWORD'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_BUCKET', variable: 'ARTEMIS_INSIGHT_MINIO_BUCKET'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_JWT_SECRET', variable: 'ARTEMIS_INSIGHT_JWT_SECRET'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_OPENAI_KEY', variable: 'ARTEMIS_INSIGHT_OPENAI_KEY'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_OPENAI_MODEL', variable: 'ARTEMIS_INSIGHT_OPENAI_MODEL')
                ]) {
                    script {
                        echo "≡ƒÜÇ === DEPLOYING ARTEMIS INSIGHT API TO PRODUCTION ==="

                        sh '''
                            echo "≡ƒöù Connecting to production server..."
                            ssh -o StrictHostKeyChecking=no ${PROD_SERVER} "
                                set -e
                                echo '≡ƒÄ» Starting Artemis Insight API deployment...'

                                # Login to registry
                                echo '≡ƒöÉ Logging into container registry...'
                                echo '${GHCR_PAT}' | docker login ghcr.io -u '${GHCR_USER}' --password-stdin

                                # Pull new image
                                echo '≡ƒôÑ Pulling new Artemis Insight API image...'
                                docker pull ${FULL_IMAGE_NAME}

                                # Stop and remove old container (NEVER infrastructure!)
                                echo '≡ƒöä Stopping old API container...'
                                docker stop artemis-insight-backend 2>/dev/null || echo 'No running container to stop'
                                docker rm artemis-insight-backend 2>/dev/null || echo 'No container to remove'

                                # Start new container
                                echo '≡ƒÜÇ Starting new Artemis Insight API container...'
                                docker run -d --name artemis-insight-backend \\
                                    -p 127.0.0.1:8002:8000 \\
                                    --restart unless-stopped \\
                                    --network artemis-insight-net \\
                                    -e APP_NAME='Artemis Insight' \\
                                    -e APP_ENV=production \\
                                    -e DEBUG=false \\
                                    -e MONGO_URI='mongodb://${ARTEMIS_INSIGHT_MONGO_USERNAME}:${ARTEMIS_INSIGHT_MONGO_PASSWORD}@artemis-insight-mongodb:27017/${ARTEMIS_INSIGHT_MONGO_DATABASE}?authSource=admin' \\
                                    -e MINIO_ENDPOINT='artemis-insight-minio:9000' \\
                                    -e MINIO_ACCESS_KEY='${ARTEMIS_INSIGHT_MINIO_USER}' \\
                                    -e MINIO_SECRET_KEY='${ARTEMIS_INSIGHT_MINIO_PASSWORD}' \\
                                    -e MINIO_BUCKET='${ARTEMIS_INSIGHT_MINIO_BUCKET}' \\
                                    -e MINIO_SECURE=false \\
                                    -e REDIS_URL='redis://artemis-insight-redis:6379/0' \\
                                    -e CELERY_BROKER_URL='redis://artemis-insight-redis:6379/0' \\
                                    -e CELERY_RESULT_BACKEND='redis://artemis-insight-redis:6379/0' \\
                                    -e JWT_SECRET_KEY='${ARTEMIS_INSIGHT_JWT_SECRET}' \\
                                    -e JWT_ALGORITHM=HS256 \\
                                    -e JWT_ACCESS_TOKEN_EXPIRE_MINUTES=15 \\
                                    -e JWT_REFRESH_TOKEN_EXPIRE_DAYS=7 \\
                                    -e OPENAI_API_KEY='${ARTEMIS_INSIGHT_OPENAI_KEY}' \\
                                    -e OPENAI_MODEL='${ARTEMIS_INSIGHT_OPENAI_MODEL}' \\
                                    -e OPENAI_EMBEDDING_MODEL='text-embedding-3-small' \\
                                    -e MONTHLY_BUDGET_ZAR=1000 \\
                                    ${FULL_IMAGE_NAME}

                                # Verify container is running
                                echo 'Γ£à Verifying container...'
                                sleep 5
                                if docker ps --filter name=artemis-insight-backend --format '{{.Status}}' | grep -q 'Up'; then
                                    echo 'Γ£à Container verified running'
                                else
                                    echo 'Γ¥î Container failed to start'
                                    docker logs artemis-insight-backend --tail 20 2>/dev/null || echo 'No logs available'
                                    exit 1
                                fi

                                echo 'Γ£à Artemis Insight API deployment completed'
                            "
                        '''

                        echo "Γ£à Artemis Insight API deployed successfully to production"
                    }
                }
            }
        }

        stage('Deploy Celery Worker') {
            steps {
                withCredentials([
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_USERNAME', variable: 'ARTEMIS_INSIGHT_MONGO_USERNAME'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_PASSWORD', variable: 'ARTEMIS_INSIGHT_MONGO_PASSWORD'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MONGO_DATABASE', variable: 'ARTEMIS_INSIGHT_MONGO_DATABASE'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_USER', variable: 'ARTEMIS_INSIGHT_MINIO_USER'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_PASSWORD', variable: 'ARTEMIS_INSIGHT_MINIO_PASSWORD'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_MINIO_BUCKET', variable: 'ARTEMIS_INSIGHT_MINIO_BUCKET'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_JWT_SECRET', variable: 'ARTEMIS_INSIGHT_JWT_SECRET'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_OPENAI_KEY', variable: 'ARTEMIS_INSIGHT_OPENAI_KEY'),
                    string(credentialsId: 'ARTEMIS_INSIGHT_OPENAI_MODEL', variable: 'ARTEMIS_INSIGHT_OPENAI_MODEL')
                ]) {
                    script {
                        echo "≡ƒÉ¥ === DEPLOYING CELERY WORKER ==="

                        sh '''
                            ssh -o StrictHostKeyChecking=no ${PROD_SERVER} "
                                set -e

                                # Deploy Celery Worker
                                echo '≡ƒÉ¥ Deploying Celery Worker...'
                                docker stop artemis-insight-celery-worker 2>/dev/null || echo 'No worker to stop'
                                docker rm artemis-insight-celery-worker 2>/dev/null || echo 'No worker to remove'

                                docker run -d --name artemis-insight-celery-worker \\
                                    --restart unless-stopped \\
                                    --network artemis-insight-net \\
                                    -e APP_NAME='Artemis Insight' \\
                                    -e APP_ENV=production \\
                                    -e MONGO_URI='mongodb://${ARTEMIS_INSIGHT_MONGO_USERNAME}:${ARTEMIS_INSIGHT_MONGO_PASSWORD}@artemis-insight-mongodb:27017/${ARTEMIS_INSIGHT_MONGO_DATABASE}?authSource=admin' \\
                                    -e MINIO_ENDPOINT='artemis-insight-minio:9000' \\
                                    -e MINIO_ACCESS_KEY='${ARTEMIS_INSIGHT_MINIO_USER}' \\
                                    -e MINIO_SECRET_KEY='${ARTEMIS_INSIGHT_MINIO_PASSWORD}' \\
                                    -e MINIO_BUCKET='${ARTEMIS_INSIGHT_MINIO_BUCKET}' \\
                                    -e MINIO_SECURE=false \\
                                    -e REDIS_URL='redis://artemis-insight-redis:6379/0' \\
                                    -e CELERY_BROKER_URL='redis://artemis-insight-redis:6379/0' \\
                                    -e CELERY_RESULT_BACKEND='redis://artemis-insight-redis:6379/0' \\
                                    -e JWT_SECRET_KEY='${ARTEMIS_INSIGHT_JWT_SECRET}' \\
                                    -e JWT_ALGORITHM=HS256 \\
                                    -e OPENAI_API_KEY='${ARTEMIS_INSIGHT_OPENAI_KEY}' \\
                                    -e OPENAI_MODEL='${ARTEMIS_INSIGHT_OPENAI_MODEL}' \\
                                    -e OPENAI_EMBEDDING_MODEL='text-embedding-3-small' \\
                                    -e MONTHLY_BUDGET_ZAR=1000 \\
                                    ${FULL_IMAGE_NAME} \\
                                    celery -A app.celery_app worker --loglevel=info --concurrency=2

                                echo 'Γ£à Celery worker deployed'
                            "
                        '''
                    }
                }
            }
        }

        stage('Post-Deploy Verification') {
            steps {
                script {
                    echo "≡ƒöì === POST-DEPLOY VERIFICATION ==="

                    sh '''
                        echo "≡ƒöì Verifying Artemis Insight API deployment..."
                        ssh -o StrictHostKeyChecking=no ${PROD_SERVER} "
                            echo '=== Container Status ==='
                            docker ps --filter name=artemis-insight

                            echo '=== API Logs (last 20 lines) ==='
                            docker logs --tail 20 artemis-insight-backend

                            echo '=== Health Check with Retry ==='
                            # Retry health check up to 30 times (30 seconds)
                            for i in \$(seq 1 30); do
                                echo \"Attempt \$i/30...\"
                                if curl -f http://localhost:8002/health; then
                                    echo 'Γ£à Health check passed!'
                                    break
                                fi
                                if [ \$i -eq 30 ]; then
                                    echo 'Γ¥î Health check failed after 30 attempts'
                                    docker logs --tail 50 artemis-insight-backend
                                    exit 1
                                fi
                                sleep 1
                            done

                            echo '=== Smoke Tests ==='
                            # Test critical endpoints
                            curl -f http://localhost:8002/docs || echo 'WARNING: Docs endpoint failed'

                            echo '=== Worker Status ==='
                            docker logs --tail 10 artemis-insight-celery-worker

                            echo 'Γ£à All post-deployment checks passed'
                        "
                    '''

                    echo "Γ£à Post-deploy verification completed"
                }
            }
        }

        stage('Rollback on Failure') {
            when {
                expression { currentBuild.result == 'FAILURE' }
            }
            steps {
                script {
                    echo "≡ƒÜÖ === ROLLBACK TRIGGERED ==="
                    sh '''
                        echo "≡ƒöÅ Rolling back to previous image..."
                        ssh -o StrictHostKeyChecking=no ${PROD_SERVER} "
                            # Stop failed container
                            docker stop artemis-insight-backend 2>/dev/null || true
                            docker rm artemis-insight-backend 2>/dev/null || true

                            # Restart with 'latest' tag (previous working version)
                            docker pull ${GHCR_URL}/${IMAGE_NAME}:latest
                            docker run -d --name artemis-insight-backend \\
                                -p 127.0.0.1:8002:8000 \\
                                --restart unless-stopped \\
                                --network artemis-insight-net \\
                                ${GHCR_URL}/${IMAGE_NAME}:latest

                            echo 'Γ£à Rollback complete - service restored'
                        " || echo "Γ¥î Rollback failed - manual intervention required"
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                echo "≡ƒº╣ === POST-BUILD CLEANUP ==="

                // Archive deployment state
                archiveArtifacts artifacts: 'deployment-state.log', allowEmptyArchive: true

                // Release build lock
                sh '''
                    echo "≡ƒöô Releasing build lock..."
                    rm -f /tmp/jenkins-artemis-insight-api-build/lock 2>/dev/null || echo "Lock cleanup completed"
                '''

                // Docker cleanup - NEVER touch infrastructure containers
                sh '''
                    set +e
                    echo "≡ƒÉ│ Docker cleanup..."
                    sleep 30
                    docker container prune -f 2>/dev/null || echo "Container cleanup completed"
                    docker image prune -f 2>/dev/null || echo "Image cleanup completed"
                    docker builder prune -f 2>/dev/null || echo "Builder cleanup completed"

                    echo "≡ƒôè Final status:"
                    free -h
                    docker system df
                '''
            }
        }
        success {
            script {
                echo "≡ƒÄë === BUILD SUCCESS ==="
                echo "Γ£à Artemis Insight API deployed successfully"
                echo "≡ƒôï Image: ${env.FULL_IMAGE_NAME}"
                echo "≡ƒöê Build duration: ${currentBuild.durationString}"
            }
        }
        failure {
            script {
                echo "≡ƒÆÑ === BUILD FAILED ==="
                echo "Γ¥î Artemis Insight API build or deployment failed"
                echo "≡ƒöì Check logs for details"

                // Send notification (if you have email/Slack configured)
                // emailext subject: "Artemis Insight API Deploy Failed",
                //          body: "Build ${env.BUILD_NUMBER} failed. Check ${env.BUILD_URL}"
            }
        }
        unstable {
            script {
                echo "ΓÜá∩╕Å === BUILD UNSTABLE ==="
                echo "Γ¥î Tests passed but health checks may have warnings"
            }
        }
    }
}
